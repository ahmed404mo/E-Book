<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مغامرة أمجد ومشمش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;600;700&display=swap');

        :root {
            --book-w: 800px;
            --book-h: 550px;
            --paper-color: #fdfbf7;
            --text-bg-color: #fffbe6; 
            --cover-color: #2c3e50;
            --accent-color: #d35400;
            --font-main: 'Readex Pro', sans-serif;
            --text-color: #4e342e; 
        }

        body {
            background-color: #263238; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: var(--font-main);
            overflow: hidden;
            touch-action: none; /* منع التكبير والتصغير باللمس */
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
        }

        .stage {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px;
            z-index: 10;
            position: relative;
        }

        .book {
            position: relative;
            width: var(--book-w);
            height: var(--book-h);
            transform-style: preserve-3d;
            transition: transform 0.8s;
            transform: rotateX(25deg); 
            box-shadow: 0 40px 80px rgba(0,0,0,0.5);
        }

        .page {
            position: absolute;
            width: 50%;
            height: 100%;
            top: 0;
            right: 0; 
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1);
            background-color: var(--paper-color);
            border-radius: 0 12px 12px 0;
            cursor: pointer;
        }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            overflow: hidden;
            background-color: var(--paper-color);
        }

        .front {
            z-index: 2;
            border-radius: 0 10px 10px 0;
            border-right: 1px solid #e0e0e0;
        }

        .back {
            transform: rotateY(180deg);
            z-index: 1;
            border-radius: 10px 0 0 10px;
            border-left: 1px solid #e0e0e0;
            box-shadow: inset -5px 0 15px rgba(0,0,0,0.05);
        }

        .front.no-border { border-right: none; }
        .back.no-border { border-left: none; }

        .page.flipped {
            transform: rotateY(-180deg);
        }

        .media-container {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            direction: ltr; 
        }
        
        .full-video {
            width: 200% !important;     
            max-width: none !important;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            pointer-events: none; 
        }

        .video-right-half { left: -100%; }
        .video-left-half { left: 0; }
        .normal-video { width: 100%; height: 100%; object-fit: cover; }

        /* تصميم حاوية الفيديو البديلة */
        .video-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background: #2d3436;
            color: white;
            text-align: center;
            padding: 20px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
        }
        .fallback-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #e67e22;
            color: white;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
            font-size: 0.9rem;
        }
        .fallback-btn:hover { background: #d35400; transform: scale(1.05); }

        .text-container {
            padding: 2rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: var(--text-bg-color);
            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: 
                inset 0 0 60px rgba(189, 140, 63, 0.1),
                0 0 0 1px rgba(0,0,0,0.05); 
            border: 6px solid #fff; 
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        .text-content {
            font-family: var(--font-main);
            font-size: 1.5rem; 
            line-height: 1.6;
            color: var(--text-color);
            font-weight: 700;
        }
        
        .page-header {
            font-family: var(--font-main);
            color: #d35400;
            font-size: 1rem;
            margin-bottom: 15px;
            background: rgba(211, 84, 0, 0.1);
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: bold;
            border: 1px solid rgba(211, 84, 0, 0.2);
        }

        .cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 5px solid var(--cover-color);
            box-sizing: border-box;
        }

        .book-title {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            text-align: center;
            color: #fff;
            font-family: var(--font-main);
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
            background: rgba(0,0,0,0.3); 
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(5px);
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .game-title {
            color: #d35400;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }
        
        .quiz-option {
            background: #ffffff;
            border: 2px solid #ecdcb3; 
            border-bottom: 4px solid #e0cda0; 
            color: var(--text-color);
            padding: 12px 15px;
            margin: 6px;
            border-radius: 15px;
            cursor: pointer;
            width: 98%;
            font-size: 1.1rem;
            font-family: var(--font-main);
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .quiz-option:hover { 
            background: #fff9c4; 
            border-color: #fbc02d;
            transform: translateY(-2px);
        }
        .quiz-option.correct { 
            background: #27ae60; 
            color: white; 
            border-color: #219150;
            border-bottom-color: #1e824c;
        }
        .quiz-option.wrong { 
            background: #e74c3c; 
            color: white; 
            border-color: #c0392b;
            border-bottom-color: #a93226;
            animation: shake 0.4s; 
        }

        .score-board {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 6px 15px;
            border-radius: 30px;
            font-weight: bold;
            color: #d35400;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            border: 2px solid #ffcc80;
        }

        .reward-star {
            position: absolute;
            font-size: 6rem;
            color: #f1c40f;
            text-shadow: 0 0 20px #e67e22;
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: none;
            z-index: 50;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes popIn { from{transform: translate(-50%, -50%) scale(0) rotate(-45deg);} to{transform: translate(-50%, -50%) scale(1) rotate(0deg);} }
        @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-8px);} 75%{transform: translateX(8px);} 100%{transform: translateX(0);} }

        .controls-bar {
            position: fixed;
            bottom: 20px;
            background: rgba(38, 50, 56, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ctrl-btn { background: none; border: none; color: #eceff1; font-size: 1.4rem; cursor: pointer; transition: 0.2s; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .ctrl-btn:hover { color: #ffd54f; transform: scale(1.15); }
        .page-num { color: #b0bec5; font-family: monospace; font-size: 1rem; font-weight: bold; }
        .video-error { position: absolute; color: white; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; display: none; font-size: 0.8rem;}

        /* تحسينات التجاوب (Mobile Responsive) */
        @media (max-width: 768px) {
            :root { 
                /* جعل الكتاب أصغر ومتناسب مع عرض الهاتف */
                --book-w: 90vw; 
                --book-h: 58vw; 
            }
            
            .book-title { font-size: 1.8rem; }
            
            .text-container {
                padding: 1rem;
                border-width: 4px;
            }
            
            .text-content { font-size: 1rem; line-height: 1.4; }
            .page-header { font-size: 0.8rem; padding: 4px 10px; margin-bottom: 10px; }
            
            .quiz-option { 
                font-size: 0.9rem; 
                padding: 8px 10px; 
                margin: 4px;
                border-bottom-width: 3px;
            }
            
            .game-title { font-size: 1.1rem; margin-bottom: 0.5rem; }
            
            .controls-bar {
                padding: 8px 15px;
                gap: 12px;
                bottom: 15px;
            }
            .ctrl-btn { font-size: 1.2rem; }
            
            .fallback-btn { font-size: 0.8rem; padding: 8px 15px; }
            .video-fallback i { font-size: 1.8rem; }
            .video-fallback p { font-size: 0.9rem; }
        }
        
        /* للهواتف الصغيرة جداً */
        @media (max-width: 480px) {
             :root {
                --book-w: 95vw;
                --book-h: 60vw;
             }
             .text-content { font-size: 0.9rem; }
             .book-title { font-size: 1.5rem; padding: 10px; }
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="score-board">
        <i class="fas fa-star fa-spin text-yellow-400" style="--fa-animation-duration: 3s;"></i>
        <span>النقاط: </span>
        <span id="scoreVal">0</span>
    </div>

    <i id="rewardStar" class="fas fa-star reward-star"></i>

    <div class="stage">
        <div class="book" id="book"></div>
    </div>

    <!-- أصوات المؤثرات من الملفات المحلية -->
    <audio id="sfxWin" src="effect/achivement.mp3"></audio>
    <audio id="sfxWrong" src="effect/wrong.mp3"></audio>

    <div class="controls-bar">
        <button class="ctrl-btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
        <button class="ctrl-btn" onclick="togglePlayPause()" id="playPauseBtn"><i class="fas fa-pause"></i></button>
        <button class="ctrl-btn" onclick="toggleMute()" id="muteBtn"><i class="fas fa-volume-up"></i></button>
        <span class="page-num" id="pageIndicator">0 / 0</span>
        <button class="ctrl-btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
    </div>

    <!-- المشغل الرئيسي للصوت -->
    <audio id="globalAudio" style="display:none"></audio>

    <script>
        // --- إعدادات Three.js لخلفية المكتب ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x263238); 
            scene.fog = new THREE.Fog(0x263238, 20, 100);
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // ضبط موضع الكاميرا بناءً على حجم الشاشة (للتجاوب)
            const isMobile = window.innerWidth < 768;
            camera.position.set(0, isMobile ? 28 : 22, isMobile ? 35 : 28); 
            camera.lookAt(0, -2, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; 
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); 
            scene.add(ambientLight);
            const deskLight = new THREE.SpotLight(0xffecb3, 1.2);
            deskLight.position.set(-15, 30, 15);
            deskLight.angle = Math.PI / 6;
            deskLight.penumbra = 0.5;
            deskLight.castShadow = true;
            deskLight.shadow.mapSize.width = 2048;
            deskLight.shadow.mapSize.height = 2048;
            scene.add(deskLight);
            const rimLight = new THREE.DirectionalLight(0xb0bec5, 0.3);
            rimLight.position.set(20, 10, -10);
            scene.add(rimLight);
            
            // --- عناصر المكتب ---
            const deskGroup = new THREE.Group();
            const topGeom = new THREE.BoxGeometry(80, 2.5, 40);
            const woodMaterial = new THREE.MeshStandardMaterial({ color: 0x4e342e, roughness: 0.5, metalness: 0.1 });
            const deskTop = new THREE.Mesh(topGeom, woodMaterial);
            deskTop.position.y = -6; 
            deskTop.receiveShadow = true;
            deskTop.castShadow = true;
            deskGroup.add(deskTop);
            const floorGeom = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x6d4c41, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeom, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -20;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Laptop
            const laptopGroup = new THREE.Group();
            const baseGeom = new THREE.BoxGeometry(12, 0.5, 8);
            const laptopMat = new THREE.MeshStandardMaterial({ color: 0x90a4ae, roughness: 0.2, metalness: 0.8 });
            const base = new THREE.Mesh(baseGeom, laptopMat);
            const lidGeom = new THREE.BoxGeometry(12, 0.2, 8);
            const lid = new THREE.Mesh(lidGeom, laptopMat);
            lid.position.y = 0.35;
            laptopGroup.add(base);
            laptopGroup.add(lid);
            laptopGroup.position.set(25, -4.5, 5);
            laptopGroup.rotation.y = -Math.PI / 6;
            laptopGroup.castShadow = true;
            deskGroup.add(laptopGroup);
            
            // Mug
            const mugGeom = new THREE.CylinderGeometry(1.5, 1.5, 3.5, 32);
            const mugMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            const mug = new THREE.Mesh(mugGeom, mugMat);
            mug.position.set(-28, -4, 8);
            mug.castShadow = true;
            const handleGeom = new THREE.TorusGeometry(1, 0.2, 8, 16, Math.PI);
            const handle = new THREE.Mesh(handleGeom, mugMat);
            handle.position.set(1.5, 0, 0);
            handle.rotation.z = -Math.PI / 2;
            mug.add(handle);
            const coffeeGeom = new THREE.CircleGeometry(1.3, 32);
            const coffeeMat = new THREE.MeshStandardMaterial({ color: 0x3e2723 });
            const coffee = new THREE.Mesh(coffeeGeom, coffeeMat);
            coffee.rotation.x = -Math.PI / 2;
            coffee.position.y = 1.5;
            mug.add(coffee);
            deskGroup.add(mug);
            
            // Lamp
            const lampGroup = new THREE.Group();
            const lBaseGeom = new THREE.CylinderGeometry(3, 3.5, 1, 32);
            const lMat = new THREE.MeshStandardMaterial({ color: 0x263238, metalness: 0.5 });
            const lBase = new THREE.Mesh(lBaseGeom, lMat);
            const lPoleGeom = new THREE.CylinderGeometry(0.3, 0.3, 10, 16);
            const lPole = new THREE.Mesh(lPoleGeom, lMat);
            lPole.position.y = 5;
            lPole.rotation.z = 0.2;
            const lHeadGeom = new THREE.ConeGeometry(2.5, 4, 32, 1, true);
            const lHead = new THREE.Mesh(lHeadGeom, new THREE.MeshStandardMaterial({ color: 0x263238, side: THREE.DoubleSide }));
            lHead.position.set(-2, 10, 0);
            lHead.rotation.z = -2;
            const bulbGeom = new THREE.SphereGeometry(0.8, 16, 16);
            const bulbMat = new THREE.MeshBasicMaterial({ color: 0xffecb3 });
            const bulb = new THREE.Mesh(bulbGeom, bulbMat);
            bulb.position.y = -1;
            lHead.add(bulb);
            lampGroup.add(lBase);
            lampGroup.add(lPole);
            lampGroup.add(lHead);
            lampGroup.position.set(-30, -4.5, -8);
            lampGroup.rotation.y = Math.PI / 4;
            lampGroup.castShadow = true;
            deskGroup.add(lampGroup);
            scene.add(deskGroup);
            
            let mouseX = 0;
            let mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) - 0.5;
                mouseY = (event.clientY / window.innerHeight) - 0.5;
            });
            
            const animate = () => {
                requestAnimationFrame(animate);
                const factor = window.innerWidth < 768 ? 1 : 3; 
                camera.position.x += (mouseX * factor - camera.position.x) * 0.05;
                const targetY = (window.innerWidth < 768 ? 28 : 22) + mouseY * 2;
                camera.position.y += (targetY - camera.position.y) * 0.05;
                camera.lookAt(0, -4, 0);
                renderer.render(scene, camera);
            };
            animate();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                const isMob = window.innerWidth < 768;
                camera.position.z = isMob ? 35 : 28;
                camera.position.y = isMob ? 28 : 22;
            });
        }
        initThreeJS();

        const assets = {
            images: {
                cover: 'https://drive.google.com/thumbnail?id=1gDlsBv4bVoL_RvrMC0a4Qlyx4p2maAov&sz=w1000',
                back: 'https://drive.google.com/thumbnail?id=12qzceeMXYlifaZDxzYFEnE9YibPLmJ1S&sz=w1000'
            },
            audio: {
                1: 'sound/1.mp3',
                2: 'sound/2.mp3',
                3: 'sound/3.mp3',
                5: 'sound/5.mp3',
                6: 'sound/6.mp3',
                7: 'sound/7.mp3',
                8: 'sound/8.mp3',
                9: 'sound/9.mp3',
                11: 'sound/11.mp3',
                12: 'sound/12.mp3',
                13: 'sound/13.mp3'
            },
            video: {
                1: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/1_nzf0au.mp4',
                2: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/2_iagdwc.mp4',
                3: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/3_w74ims.mp4',
                4: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/4_a4ctee.mp4',
                5: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/5_ddmu0h.mp4',
                6: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/6_w5q6ne.mp4',
                7: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/7_brz0sh.mp4',
                8: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/8_xslb1x.mp4',
                9: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/9_gdgue5.mp4', 
                10: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/10_kuopqc.mp4',
                11: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/11_n2lkjv.mp4',
                12: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/12_l7awif.mp4',
                13: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/13_f2bg0v.mp4',
                14: 'https://res.cloudinary.com/dhvuw8yog/video/upload/video/14_jfwwa7.mp4'
            }
        };

        const storyConfig = [
            { type: 'cover' }, 
            { id: 1, text: "استيقظ أمجد بحماس شديد، اليوم سيزور مكاناً مدهشاً مع صديقه القط الذكي 'مشمش'." },
            { id: 2, text: "وصل الصديقان أمام المتحف الضخم. قال مشمش: 'أنا مرشدك اليوم لاستكشاف كنوز مصر!'" },
            {
                type: 'quiz-double',
                right: { question: "من هو مرافق أمجد في الرحلة؟", options: ["الكلب بوبي", "القط مشمش", "العصفور تويتي"], correct: 1 },
                left: { question: "كيف كان شعور أمجد في الصباح؟", options: ["حزين", "متحمس", "غاضب"], correct: 1 }
            },
            { id: 3, text: "وقف أمجد مبهوراً أمام تمثال رمسيس الثاني العظيم." },
            { id: 4, text: "", forceFullVideo: true }, 
            { id: 5, text: "قال مشمش: 'هذا الملك حكم مصر لأكثر من 60 عاماً وكان قوياً ومحبوباً.'" },
            { id: 6, text: "دخلا غرفة الكنوز الذهبية، ورأى أمجد قناعاً يلمع بشدة." },
            { id: 7, text: "'إنه قناع الملك توت عنخ آمون!'، قال مشمش، 'مصنوع من الذهب الخالص!'" },
            {
                type: 'quiz-double',
                right: { question: "ما اسم الملك صاحب القناع الذهبي؟", options: ["أحمس", "توت عنخ آمون", "خوفو"], correct: 1 },
                left: { question: "من ماذا صُنع القناع؟", options: ["الخشب", "الحديد", "الذهب الخالص"], correct: 2 }
            },
            { id: 8, text: "شاهد أمجد التابوت المزخرف وسأل عن سر بقاء المومياوات." },
            { id: 9, text: "شرح مشمش عملية 'التحنيط' التي تحفظ الأجسام لآلاف السنين." },
            { id: 10, text: "", forceFullVideo: true }, 
            { id: 11, text: "لعب أمجد ومشمش لعبة البحث عن الكنوز على الخريطة القديمة." },
            {
                type: 'quiz-double',
                right: { question: "ماذا وجد أمجد في الخريطة؟", options: ["كنز مخفي", "سيارة", "كرة"], correct: 0 },
                left: { question: "أين توجد الأهرامات؟", options: ["في البحر", "في الجيزة", "في المتحف"], correct: 1 }
            },
            { id: 12, text: "رأى أمجد المومياوات الحقيقية التي حفظها المصريون ببراعة." },
            { id: 13, text: "تعرف أمجد على أدوات الزراعة والطهي، وتمثال الإله 'أنوبيس'." },
            { id: 14, text: "", forceFullVideo: true }, 
            { type: 'back-cover' }
        ];

        let currentPage = 0; 
        let score = 0;
        const bookEl = document.getElementById('book');
        const audioEl = document.getElementById('globalAudio');
        let isPlaying = false; 
        let firstInteraction = false; 

        document.body.addEventListener("click", () => {
            if (!firstInteraction) {
                firstInteraction = true;
                isPlaying = true;
                
                if(audioEl.context && audioEl.context.state === 'suspended') {
                    audioEl.context.resume();
                }
                
                updateBook();
            }
        }, { once: true });

        function initBook() {
            bookEl.innerHTML = '';
            for (let i = 0; i < storyConfig.length; i++) {
                const currentData = storyConfig[i];
                const nextData = (i + 1 < storyConfig.length) ? storyConfig[i+1] : null;

                const pageDiv = document.createElement('div');
                pageDiv.className = `page`;
                pageDiv.id = `page-${i}`;
                pageDiv.style.zIndex = storyConfig.length - i; 
                
                let frontHTML = '';
                let frontClass = 'front';
                
                if (currentData.type === 'cover') {
                    frontHTML = `<img src="${assets.images.cover}" class="cover-img" onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=text-container>جار تحميل الغلاف...</div>'"><h1 class="book-title">مغامرة أمجد ومشمش</h1>`;
                } else if (currentData.type === 'back-cover') {
                    frontHTML = `<div class="text-container"><h2 class="text-3xl font-bold">النهاية</h2><p>شكراً لمتابعتكم</p></div>`;
                } else if (currentData.type === 'quiz-double') {
                    frontHTML = createQuizHTML(currentData.right);
                } else if (currentData.forceFullVideo) {
                    frontClass += ' no-border'; 
                    let vidSrc = assets.video[currentData.id] || '';
                    if (vidSrc.includes('mediafire.com')) {
                        frontHTML = `
                        <div class="media-container">
                            <div class="video-fallback">
                                <i class="fas fa-film text-4xl mb-3 text-orange-400"></i>
                                <p class="mb-4 text-lg">فيديو ${currentData.id}</p>
                                <a href="${vidSrc}" target="_blank" class="fallback-btn">
                                    <i class="fas fa-external-link-alt"></i> مشاهدة الفيديو
                                </a>
                            </div>
                        </div>`;
                    } else {
                        frontHTML = `
                        <div class="media-container">
                            <video id="vid-front-${i}" class="full-video video-right-half" data-src="${vidSrc}" loop muted playsinline preload="none" onerror="handleVideoError(this, '${vidSrc}')"></video>
                        </div>`;
                    }
                } else {
                    frontHTML = `<div class="text-container"><div class="page-header">صفحة ${currentData.id}</div><p class="text-content">${currentData.text}</p></div>`;
                }

                let backHTML = '';
                let backClass = 'back';
                
                if (nextData) {
                    if (nextData.type === 'back-cover') {
                        backHTML = `<img src="${assets.images.back}" class="cover-img" onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=text-container>جار تحميل الغلاف الخلفي...</div>'">`;
                    } else if (nextData.type === 'quiz-double') {
                        backHTML = createQuizHTML(nextData.left);
                    } else if (nextData.forceFullVideo) {
                        backClass += ' no-border'; 
                        let vidSrc = assets.video[nextData.id] || '';
                        
                        if (vidSrc.includes('mediafire.com')) {
                            backHTML = `
                            <div class="media-container">
                                <div class="video-fallback">
                                    <i class="fas fa-film text-4xl mb-3 text-orange-400"></i>
                                    <p class="mb-4 text-lg">فيديو ${nextData.id}</p>
                                    <a href="${vidSrc}" target="_blank" class="fallback-btn">
                                        <i class="fas fa-external-link-alt"></i> مشاهدة الفيديو
                                    </a>
                                </div>
                            </div>`;
                        } else {
                            backHTML = `
                            <div class="media-container">
                                <video id="vid-back-${i}" class="full-video video-left-half" data-src="${vidSrc}" loop muted playsinline preload="none" onerror="handleVideoError(this, '${vidSrc}')"></video>
                            </div>`;
                        }
                    } else {
                        let vidSrc = nextData.id ? (assets.video[nextData.id] || '') : '';
                        if (vidSrc) {
                            if (vidSrc.includes('mediafire.com')) {
                                 backHTML = `
                                    <div class="media-container">
                                        <div class="video-fallback">
                                            <i class="fas fa-film text-4xl mb-3 text-orange-400"></i>
                                            <p class="mb-4 text-lg">فيديو ${nextData.id}</p>
                                            <a href="${vidSrc}" target="_blank" class="fallback-btn">
                                                <i class="fas fa-external-link-alt"></i> مشاهدة الفيديو
                                            </a>
                                        </div>
                                    </div>`;
                            } else {
                                backHTML = `
                                <div class="media-container">
                                    <video id="vid-back-${i}" class="normal-video" data-src="${vidSrc}" loop playsinline muted preload="none" onerror="handleVideoError(this, '${vidSrc}')"></video>
                                </div>`;
                            }
                        } else {
                             backHTML = `<div class="text-container" style="background:#ddd;"></div>`;
                        }
                    }
                } else {
                    backHTML = `<div class="text-container" style="background:#ddd;"></div>`; 
                }

                pageDiv.innerHTML = `<div class="${frontClass}">${frontHTML}</div><div class="${backClass}">${backHTML}</div>`;
                bookEl.appendChild(pageDiv);
            }
        }

        function handleVideoError(videoElement, src) {
            videoElement.style.display = 'none';
            const container = videoElement.parentNode;
            if(container.querySelector('.video-fallback')) return;
            
            const fallbackDiv = document.createElement('div');
            fallbackDiv.className = 'video-fallback';
            fallbackDiv.innerHTML = `
                <i class="fas fa-video-slash text-4xl mb-3 text-red-400"></i>
                <p class="mb-4 text-lg">تعذر تشغيل الفيديو</p>
                <a href="${src}" target="_blank" class="fallback-btn">
                    <i class="fas fa-external-link-alt"></i> مشاهدة الفيديو
                </a>
            `;
            container.appendChild(fallbackDiv);
        }

        function createQuizHTML(data) {
            let optionsHTML = data.options.map((opt, idx) => `<div class="quiz-option" onclick="checkAnswer(this, ${idx === data.correct})">${opt}</div>`).join('');
            return `<div class="text-container"><div class="game-title">سؤال التحدي!</div><div class="text-content" style="font-size:1.4rem; margin-bottom:1rem">${data.question}</div>${optionsHTML}</div>`;
        }

        function checkAnswer(btn, isCorrect) {
            if (btn.classList.contains('correct') || btn.classList.contains('wrong')) return; 
            if (isCorrect) {
                btn.classList.add('correct');
                score += 10;
                document.getElementById('scoreVal').innerText = score;
                const winSfx = document.getElementById('sfxWin');
                winSfx.currentTime = 0; 
                winSfx.play().catch(e => {});
                showReward();
            } else {
                btn.classList.add('wrong');
                const wrongSfx = document.getElementById('sfxWrong');
                wrongSfx.currentTime = 0; 
                wrongSfx.play().catch(e => {});
            }
        }

        function showReward() {
            const star = document.getElementById('rewardStar');
            star.style.display = 'block';
            setTimeout(() => { star.style.display = 'none'; }, 1000);
        }

        function nextPage() {
            if (currentPage < storyConfig.length) { currentPage++; updateBook(); }
        }

        function prevPage() {
            if (currentPage > 0) { currentPage--; updateBook(); }
        }

        function loadVideoIfNeeded(vid) {
            if (vid && !vid.getAttribute('src') && vid.dataset.src) {
                vid.src = vid.dataset.src;
                vid.load();
            }
        }

        function updateBook() {
            const pages = document.querySelectorAll('.page');
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${storyConfig.length}`;

            pages.forEach((p, index) => {
                if (index < currentPage) {
                    p.classList.add('flipped');
                    p.style.zIndex = index; 
                } else {
                    p.classList.remove('flipped');
                    p.style.zIndex = storyConfig.length - index; 
                }
            });

            document.querySelectorAll('video').forEach(v => {
                v.pause();
            });
            
            let leftVid = (currentPage > 0) ? document.querySelector(`#vid-back-${currentPage-1}`) : null;
            let rightVid = (currentPage < storyConfig.length) ? document.querySelector(`#vid-front-${currentPage}`) : null;

            if(leftVid) loadVideoIfNeeded(leftVid);
            if(rightVid) loadVideoIfNeeded(rightVid);

            if (currentPage + 1 < storyConfig.length) {
                 let nextVid = document.querySelector(`#vid-front-${currentPage+1}`);
                 if(nextVid) loadVideoIfNeeded(nextVid);
            }

            let isFullVideo = false;
            if (currentPage < storyConfig.length && storyConfig[currentPage].forceFullVideo) {
                isFullVideo = true;
            } 
            else if (currentPage > 0 && storyConfig[currentPage-1].forceFullVideo) {
                if (storyConfig[currentPage] && storyConfig[currentPage].forceFullVideo) isFullVideo = true;
            }

            if(isPlaying) {
                if (isFullVideo && rightVid && leftVid) {
                    audioEl.pause(); 
                    leftVid.currentTime = 0;
                    leftVid.muted = true;
                    leftVid.play().catch(e => {});

                    rightVid.currentTime = 0;
                    rightVid.muted = false; 
                    rightVid.play().catch(e => {});
                } 
                else {
                    if(leftVid) { leftVid.currentTime = 0; leftVid.play().catch(e => {}); }
                    if(rightVid) { rightVid.currentTime = 0; rightVid.play().catch(e => {}); }
                    playAudioForPage(currentPage);
                }
            } else {
                audioEl.pause();
            }
        }

        function playAudioForPage(idx) {
            let pageData = storyConfig[idx];
            if (pageData && pageData.forceFullVideo) return;

            if (pageData && pageData.id && assets.audio[pageData.id]) {
                audioEl.src = assets.audio[pageData.id];
                audioEl.play().catch(e => {});
            } else {
                audioEl.pause();
            }
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playPauseBtn');
            btn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            updateBook(); 
        }

        function toggleMute() {
            const allMedia = [...document.querySelectorAll('video'), audioEl, document.getElementById('sfxWin'), document.getElementById('sfxWrong')];
            let isMuted = !audioEl.muted; 
            allMedia.forEach(m => m.muted = isMuted);
            
            const btn = document.getElementById('muteBtn');
            btn.innerHTML = audioEl.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        }

        initBook();

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextPage();
            if (e.key === 'ArrowLeft') prevPage();
        });

    </script>
</body>
</html>