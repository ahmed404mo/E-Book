<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مغامرة أمجد ومشمش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- مكتبة Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Readex+Pro:wght@400;600;700&display=swap');

        :root {
            --book-w: 800px;
            --book-h: 550px;
            --paper-color: #fdfbf7;
            /* لون خلفية النص: كريمي مائل للاصفرار (Warm Yellowish Cream) - مريح للعين */
            --text-bg-color: #fffbe6; 
            --cover-color: #2c3e50;
            --accent-color: #d35400;
            --font-main: 'Readex Pro', sans-serif;
            --text-color: #4e342e; /* بني غامق دافئ للقراءة */
        }

        body {
            background-color: #263238; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: var(--font-main);
            overflow: hidden;
        }

        /* حاوية Three.js */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
        }

        .stage {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px;
            z-index: 10;
            position: relative;
        }

        .book {
            position: relative;
            width: var(--book-w);
            height: var(--book-h);
            transform-style: preserve-3d;
            transition: transform 0.8s;
            transform: rotateX(25deg); 
            box-shadow: 0 40px 80px rgba(0,0,0,0.5); /* ظل قوي لزيادة الواقعية */
        }

        .page {
            position: absolute;
            width: 50%;
            height: 100%;
            top: 0;
            right: 0; 
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.645, 0.045, 0.355, 1);
            background-color: var(--paper-color);
            border-radius: 0 12px 12px 0;
            cursor: pointer;
        }

        .front, .back {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            overflow: hidden;
            background-color: var(--paper-color);
        }

        .front {
            z-index: 2;
            border-radius: 0 10px 10px 0;
            border-right: 1px solid #e0e0e0;
        }

        .back {
            transform: rotateY(180deg);
            z-index: 1;
            border-radius: 10px 0 0 10px;
            border-left: 1px solid #e0e0e0;
            box-shadow: inset -5px 0 15px rgba(0,0,0,0.05);
        }

        .front.no-border { border-right: none; }
        .back.no-border { border-left: none; }

        .page.flipped {
            transform: rotateY(-180deg);
        }

        .media-container {
            width: 100%;
            height: 100%;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            direction: ltr; 
        }
        
        .full-video {
            width: 200% !important;     
            max-width: none !important;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            pointer-events: none; 
        }

        .video-right-half { left: -100%; }
        .video-left-half { left: 0; }
        .normal-video { width: 100%; height: 100%; object-fit: cover; }

        /* تعديل تصميم حاوية النص ليتناسب مع الخلفية المسفرة */
        .text-container {
            padding: 2.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: var(--text-bg-color); /* اللون الجديد */
            /* إضافة نسيج خفيف (Noise) لمحاكاة الورق */
            background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: 
                inset 0 0 60px rgba(189, 140, 63, 0.1), /* توهج داخلي دافئ */
                0 0 0 1px rgba(0,0,0,0.05); 
            border: 8px solid #fff; 
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        .text-content {
            font-family: var(--font-main);
            font-size: 1.6rem; 
            line-height: 1.8;
            color: var(--text-color);
            font-weight: 700;
        }
        
        .page-header {
            font-family: var(--font-main);
            color: #d35400;
            font-size: 1.1rem;
            margin-bottom: 20px;
            background: rgba(211, 84, 0, 0.1);
            padding: 6px 20px;
            border-radius: 50px;
            font-weight: bold;
            border: 1px solid rgba(211, 84, 0, 0.2);
        }

        .cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 5px solid var(--cover-color);
            box-sizing: border-box;
        }

        .book-title {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            text-align: center;
            color: #fff;
            font-family: var(--font-main);
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
            background: rgba(0,0,0,0.3); 
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(5px);
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .game-title {
            color: #d35400;
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
        }
        
        .quiz-option {
            background: #ffffff;
            border: 2px solid #ecdcb3; 
            border-bottom: 5px solid #e0cda0; 
            color: var(--text-color);
            padding: 15px 20px;
            margin: 8px;
            border-radius: 15px;
            cursor: pointer;
            width: 95%;
            font-size: 1.2rem;
            font-family: var(--font-main);
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .quiz-option:hover { 
            background: #fff9c4; /* أصفر فاتح جداً عند التحويم */
            border-color: #fbc02d;
            transform: translateY(-2px);
        }
        .quiz-option.correct { 
            background: #27ae60; 
            color: white; 
            border-color: #219150;
            border-bottom-color: #1e824c;
        }
        .quiz-option.wrong { 
            background: #e74c3c; 
            color: white; 
            border-color: #c0392b;
            border-bottom-color: #a93226;
            animation: shake 0.4s; 
        }

        .score-board {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 8px 25px;
            border-radius: 30px;
            font-weight: bold;
            color: #d35400;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            border: 2px solid #ffcc80;
        }

        .reward-star {
            position: absolute;
            font-size: 8rem;
            color: #f1c40f;
            text-shadow: 0 0 20px #e67e22;
            animation: popIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: none;
            z-index: 50;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes popIn { from{transform: translate(-50%, -50%) scale(0) rotate(-45deg);} to{transform: translate(-50%, -50%) scale(1) rotate(0deg);} }
        @keyframes shake { 0%{transform: translateX(0);} 25%{transform: translateX(-8px);} 75%{transform: translateX(8px);} 100%{transform: translateX(0);} }

        .controls-bar {
            position: fixed;
            bottom: 25px;
            background: rgba(38, 50, 56, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 30px;
            border-radius: 50px;
            display: flex;
            gap: 25px;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .ctrl-btn { background: none; border: none; color: #eceff1; font-size: 1.5rem; cursor: pointer; transition: 0.2s; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .ctrl-btn:hover { color: #ffd54f; transform: scale(1.15); }
        .page-num { color: #b0bec5; font-family: monospace; font-size: 1.2rem; font-weight: bold; }
        .video-error { position: absolute; color: white; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; display: none; }

        @media (max-width: 768px) {
            :root { --book-w: 95vw; --book-h: 60vh; }
            .book-title { font-size: 1.8rem; }
            .text-content { font-size: 1.1rem; }
            .quiz-option { font-size: 1rem; padding: 10px; }
            .game-title { font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <!-- حاوية Three.js -->
    <div id="canvas-container"></div>

    <div class="score-board">
        <i class="fas fa-star fa-spin text-yellow-400" style="--fa-animation-duration: 3s;"></i>
        <span>النقاط: </span>
        <span id="scoreVal">0</span>
    </div>

    <i id="rewardStar" class="fas fa-star reward-star"></i>

    <div class="stage">
        <div class="book" id="book"></div>
    </div>

    <!-- الأصوات -->
    <audio id="sfxWin" src="effect/achivement.mp3"></audio>
    <audio id="sfxWrong" src="effect/wrong.mp3"></audio>

    <div class="controls-bar">
        <button class="ctrl-btn" onclick="nextPage()"><i class="fas fa-chevron-right"></i></button>
        <button class="ctrl-btn" onclick="togglePlayPause()" id="playPauseBtn"><i class="fas fa-pause"></i></button>
        <button class="ctrl-btn" onclick="toggleMute()" id="muteBtn"><i class="fas fa-volume-up"></i></button>
        <span class="page-num" id="pageIndicator">0 / 0</span>
        <button class="ctrl-btn" onclick="prevPage()"><i class="fas fa-chevron-left"></i></button>
    </div>

    <audio id="globalAudio" style="display:none"></audio>

    <script>
        // --- إعدادات Three.js لتصميم مكتب احترافي وواقعي ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            
            // لون الخلفية (رمادي غامق أنيق)
            scene.background = new THREE.Color(0x263238); 
            // إضافة ضباب خفيف للعمق
            scene.fog = new THREE.Fog(0x263238, 20, 100);

            // الكاميرا
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 22, 28); // زاوية مرتفعة لرؤية المكتب بوضوح
            camera.lookAt(0, -2, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; 
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; // ظلال ناعمة
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            // --- الإضاءة (محسنة لجو دافئ) ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); 
            scene.add(ambientLight);

            // ضوء رئيسي (مصباح مكتب دافئ)
            const deskLight = new THREE.SpotLight(0xffecb3, 1.2);
            deskLight.position.set(-15, 30, 15);
            deskLight.angle = Math.PI / 6;
            deskLight.penumbra = 0.5;
            deskLight.castShadow = true;
            deskLight.shadow.mapSize.width = 2048;
            deskLight.shadow.mapSize.height = 2048;
            scene.add(deskLight);

            // ضوء جانبي بارد للتوازن
            const rimLight = new THREE.DirectionalLight(0xb0bec5, 0.3);
            rimLight.position.set(20, 10, -10);
            scene.add(rimLight);

            // --- تصميم المكتب ---
            const deskGroup = new THREE.Group();

            // 1. سطح المكتب (خشب ماهوجني غامق)
            const topGeom = new THREE.BoxGeometry(80, 2.5, 40);
            const woodMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4e342e, 
                roughness: 0.5,
                metalness: 0.1
            });
            const deskTop = new THREE.Mesh(topGeom, woodMaterial);
            deskTop.position.y = -6; 
            deskTop.receiveShadow = true;
            deskTop.castShadow = true;
            deskGroup.add(deskTop);

            // 2. الأرضية (خشب باركيه فاتح)
            const floorGeom = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x6d4c41, 
                roughness: 0.8 
            });
            const floor = new THREE.Mesh(floorGeom, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -20;
            floor.receiveShadow = true;
            scene.add(floor);

            // --- إكسسوارات المكتب ---
            
            // 1. لابتوب مغلق (Laptop)
            const laptopGroup = new THREE.Group();
            // القاعدة
            const baseGeom = new THREE.BoxGeometry(12, 0.5, 8);
            const laptopMat = new THREE.MeshStandardMaterial({ color: 0x90a4ae, roughness: 0.2, metalness: 0.8 });
            const base = new THREE.Mesh(baseGeom, laptopMat);
            // الغطاء
            const lidGeom = new THREE.BoxGeometry(12, 0.2, 8);
            const lid = new THREE.Mesh(lidGeom, laptopMat);
            lid.position.y = 0.35;
            
            laptopGroup.add(base);
            laptopGroup.add(lid);
            laptopGroup.position.set(25, -4.5, 5);
            laptopGroup.rotation.y = -Math.PI / 6;
            laptopGroup.castShadow = true;
            deskGroup.add(laptopGroup);

            // 2. كوب قهوة (Mug)
            const mugGeom = new THREE.CylinderGeometry(1.5, 1.5, 3.5, 32);
            const mugMat = new THREE.MeshStandardMaterial({ color: 0xffffff }); // كوب أبيض
            const mug = new THREE.Mesh(mugGeom, mugMat);
            mug.position.set(-28, -4, 8);
            mug.castShadow = true;
            
            // مقبض الكوب
            const handleGeom = new THREE.TorusGeometry(1, 0.2, 8, 16, Math.PI);
            const handle = new THREE.Mesh(handleGeom, mugMat);
            handle.position.set(1.5, 0, 0);
            handle.rotation.z = -Math.PI / 2;
            mug.add(handle);
            
            // القهوة بداخل الكوب
            const coffeeGeom = new THREE.CircleGeometry(1.3, 32);
            const coffeeMat = new THREE.MeshStandardMaterial({ color: 0x3e2723 });
            const coffee = new THREE.Mesh(coffeeGeom, coffeeMat);
            coffee.rotation.x = -Math.PI / 2;
            coffee.position.y = 1.5;
            mug.add(coffee);

            deskGroup.add(mug);

            // 3. مصباح مكتب حديث
            const lampGroup = new THREE.Group();
            const lBaseGeom = new THREE.CylinderGeometry(3, 3.5, 1, 32);
            const lMat = new THREE.MeshStandardMaterial({ color: 0x263238, metalness: 0.5 });
            const lBase = new THREE.Mesh(lBaseGeom, lMat);
            
            const lPoleGeom = new THREE.CylinderGeometry(0.3, 0.3, 10, 16);
            const lPole = new THREE.Mesh(lPoleGeom, lMat);
            lPole.position.y = 5;
            lPole.rotation.z = 0.2;

            const lHeadGeom = new THREE.ConeGeometry(2.5, 4, 32, 1, true);
            const lHead = new THREE.Mesh(lHeadGeom, new THREE.MeshStandardMaterial({ color: 0x263238, side: THREE.DoubleSide }));
            lHead.position.set(-2, 10, 0);
            lHead.rotation.z = -2;

            // لمبة مضيئة داخل الرأس
            const bulbGeom = new THREE.SphereGeometry(0.8, 16, 16);
            const bulbMat = new THREE.MeshBasicMaterial({ color: 0xffecb3 });
            const bulb = new THREE.Mesh(bulbGeom, bulbMat);
            bulb.position.y = -1;
            lHead.add(bulb);

            lampGroup.add(lBase);
            lampGroup.add(lPole);
            lampGroup.add(lHead);
            lampGroup.position.set(-30, -4.5, -8);
            lampGroup.rotation.y = Math.PI / 4;
            lampGroup.castShadow = true;
            deskGroup.add(lampGroup);

            scene.add(deskGroup);

            // تفاعل الماوس للكاميرا
            let mouseX = 0;
            let mouseY = 0;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) - 0.5;
                mouseY = (event.clientY / window.innerHeight) - 0.5;
            });

            const animate = () => {
                requestAnimationFrame(animate);

                // حركة كاميرا ناعمة جداً
                camera.position.x += (mouseX * 3 - camera.position.x) * 0.05;
                camera.position.y += (22 + mouseY * 2 - camera.position.y) * 0.05;
                camera.lookAt(0, -4, 0);

                renderer.render(scene, camera);
            };

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        initThreeJS();

        // --- كود الكتاب والمنطق (لم يتغير) ---
        const storyConfig = [
            { type: 'cover', imgRight: 'image/1.png' }, 
            { id: 1, text: "استيقظ أمجد بحماس شديد، اليوم سيزور مكاناً مدهشاً مع صديقه القط الذكي 'مشمش'." },
            { id: 2, text: "وصل الصديقان أمام المتحف الضخم. قال مشمش: 'أنا مرشدك اليوم لاستكشاف كنوز مصر!'" },
            {
                type: 'quiz-double',
                right: { question: "من هو مرافق أمجد في الرحلة؟", options: ["الكلب بوبي", "القط مشمش", "العصفور تويتي"], correct: 1 },
                left: { question: "كيف كان شعور أمجد في الصباح؟", options: ["حزين", "متحمس", "غاضب"], correct: 1 }
            },
            { id: 3, text: "وقف أمجد مبهوراً أمام تمثال رمسيس الثاني العظيم." },
            { id: 4, text: "", forceFullVideo: true }, 
            { id: 5, text: "قال مشمش: 'هذا الملك حكم مصر لأكثر من 60 عاماً وكان قوياً ومحبوباً.'" },
            { id: 6, text: "دخلا غرفة الكنوز الذهبية، ورأى أمجد قناعاً يلمع بشدة." },
            { id: 7, text: "'إنه قناع الملك توت عنخ آمون!'، قال مشمش، 'مصنوع من الذهب الخالص!'" },
            {
                type: 'quiz-double',
                right: { question: "ما اسم الملك صاحب القناع الذهبي؟", options: ["أحمس", "توت عنخ آمون", "خوفو"], correct: 1 },
                left: { question: "من ماذا صُنع القناع؟", options: ["الخشب", "الحديد", "الذهب الخالص"], correct: 2 }
            },
            { id: 8, text: "شاهد أمجد التابوت المزخرف وسأل عن سر بقاء المومياوات." },
            { id: 9, text: "شرح مشمش عملية 'التحنيط' التي تحفظ الأجسام لآلاف السنين." },
            { id: 10, text: "", forceFullVideo: true },
            { id: 11, text: "لعب أمجد ومشمش لعبة البحث عن الكنوز على الخريطة القديمة." },
            {
                type: 'quiz-double',
                right: { question: "ماذا وجد أمجد في الخريطة؟", options: ["كنز مخفي", "سيارة", "كرة"], correct: 0 },
                left: { question: "أين توجد الأهرامات؟", options: ["في البحر", "في الجيزة", "في المتحف"], correct: 1 }
            },
            { id: 12, text: "رأى أمجد المومياوات الحقيقية التي حفظها المصريون ببراعة." },
            { id: 13, text: "تعرف أمجد على أدوات الزراعة والطهي، وتمثال الإله 'أنوبيس'." },
            { id: 14, text: "", forceFullVideo: true },
            { type: 'back-cover', img: 'image/2.png' }
        ];

        let currentPage = 0; 
        let score = 0;
        const bookEl = document.getElementById('book');
        const audioEl = document.getElementById('globalAudio');
        let isPlaying = true; 

        function initBook() {
            bookEl.innerHTML = '';
            for (let i = 0; i < storyConfig.length; i++) {
                const currentData = storyConfig[i];
                const nextData = (i + 1 < storyConfig.length) ? storyConfig[i+1] : null;

                const pageDiv = document.createElement('div');
                pageDiv.className = `page`;
                pageDiv.id = `page-${i}`;
                pageDiv.style.zIndex = storyConfig.length - i; 
                
                let frontHTML = '';
                let frontClass = 'front';
                
                if (currentData.type === 'cover') {
                    frontHTML = `<img src="${currentData.imgRight}" class="cover-img" onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=text-container>صورة الغلاف مفقودة<br>image/1.png</div>'"><h1 class="book-title">مغامرة أمجد ومشمش</h1>`;
                } else if (currentData.type === 'back-cover') {
                    frontHTML = `<div class="text-container"><h2 class="text-3xl font-bold">النهاية</h2><p>شكراً لمتابعتكم</p></div>`;
                } else if (currentData.type === 'quiz-double') {
                    frontHTML = createQuizHTML(currentData.right);
                } else if (currentData.forceFullVideo) {
                    frontClass += ' no-border'; 
                    let vidSrc = `video/${currentData.id}.mp4`;
                    frontHTML = `<div class="media-container"><video id="vid-front-${i}" class="full-video video-right-half" src="${vidSrc}" loop muted onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=video-error>فيديو ${currentData.id}.mp4 مفقود</div>'"></video></div>`;
                } else {
                    frontHTML = `<div class="text-container"><div class="page-header">صفحة ${currentData.id}</div><p class="text-content">${currentData.text}</p></div>`;
                }

                let backHTML = '';
                let backClass = 'back';
                
                if (nextData) {
                    if (nextData.type === 'back-cover') {
                        backHTML = `<img src="${nextData.img}" class="cover-img" onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=text-container>الغلاف الخلفي مفقود<br>image/2.png</div>'">`;
                    } else if (nextData.type === 'quiz-double') {
                        backHTML = createQuizHTML(nextData.left);
                    } else if (nextData.forceFullVideo) {
                        backClass += ' no-border'; 
                        let vidSrc = `video/${nextData.id}.mp4`;
                        backHTML = `<div class="media-container"><video id="vid-back-${i}" class="full-video video-left-half" src="${vidSrc}" loop muted onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=video-error>فيديو ${nextData.id}.mp4 مفقود</div>'"></video></div>`;
                    } else {
                        let vidSrc = nextData.id ? `video/${nextData.id}.mp4` : '';
                        backHTML = `<div class="media-container"><video id="vid-back-${i}" class="normal-video" src="${vidSrc}" loop playsinline muted onerror="this.style.display='none'; this.parentNode.innerHTML+='<div class=video-error>فيديو ${nextData.id}.mp4 مفقود</div>'"></video></div>`;
                    }
                } else {
                    backHTML = `<div class="text-container" style="background:#ddd;"></div>`; 
                }

                pageDiv.innerHTML = `<div class="${frontClass}">${frontHTML}</div><div class="${backClass}">${backHTML}</div>`;
                bookEl.appendChild(pageDiv);
            }
            updateBook();
        }

        function createQuizHTML(data) {
            let optionsHTML = data.options.map((opt, idx) => `<div class="quiz-option" onclick="checkAnswer(this, ${idx === data.correct})">${opt}</div>`).join('');
            return `<div class="text-container"><div class="game-title">سؤال التحدي!</div><div class="text-content" style="font-size:1.4rem; margin-bottom:1rem">${data.question}</div>${optionsHTML}</div>`;
        }

        function checkAnswer(btn, isCorrect) {
            if (btn.classList.contains('correct') || btn.classList.contains('wrong')) return; 
            if (isCorrect) {
                btn.classList.add('correct');
                score += 10;
                document.getElementById('scoreVal').innerText = score;
                const winSfx = document.getElementById('sfxWin');
                winSfx.currentTime = 0; 
                winSfx.play().catch(e => console.log('SFX play failed', e));
                showReward();
            } else {
                btn.classList.add('wrong');
                const wrongSfx = document.getElementById('sfxWrong');
                wrongSfx.currentTime = 0; 
                wrongSfx.play().catch(e => console.log('SFX play failed', e));
            }
        }

        function showReward() {
            const star = document.getElementById('rewardStar');
            star.style.display = 'block';
            setTimeout(() => { star.style.display = 'none'; }, 1000);
        }

        function nextPage() {
            if (currentPage < storyConfig.length) { currentPage++; updateBook(); }
        }

        function prevPage() {
            if (currentPage > 0) { currentPage--; updateBook(); }
        }

        function updateBook() {
            const pages = document.querySelectorAll('.page');
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${storyConfig.length}`;

            pages.forEach((p, index) => {
                if (index < currentPage) {
                    p.classList.add('flipped');
                    p.style.zIndex = index; 
                } else {
                    p.classList.remove('flipped');
                    p.style.zIndex = storyConfig.length - index; 
                }
            });

            document.querySelectorAll('video').forEach(v => {
                v.pause();
                v.muted = true; 
            });
            
            let leftVid = (currentPage > 0) ? document.querySelector(`#vid-back-${currentPage-1}`) : null;
            let rightVid = (currentPage < storyConfig.length) ? document.querySelector(`#vid-front-${currentPage}`) : null;

            let isFullVideo = false;
            
            if (currentPage < storyConfig.length && storyConfig[currentPage].forceFullVideo) {
                isFullVideo = true;
            } 
            else if (currentPage > 0 && storyConfig[currentPage-1].forceFullVideo) {
                if (storyConfig[currentPage] && storyConfig[currentPage].forceFullVideo) isFullVideo = true;
            }

            if(isPlaying) {
                if (isFullVideo && rightVid && leftVid) {
                    audioEl.pause(); 
                    leftVid.currentTime = 0;
                    leftVid.muted = true;
                    leftVid.play().catch(()=>{});

                    rightVid.currentTime = 0;
                    rightVid.muted = false; 
                    rightVid.play().catch(()=>{});
                } 
                else {
                    if(leftVid) { leftVid.currentTime = 0; leftVid.play().catch(()=>{}); }
                    if(rightVid) { rightVid.currentTime = 0; rightVid.play().catch(()=>{}); }
                    playAudioForPage(currentPage);
                }
            } else {
                audioEl.pause();
            }
        }

        function playAudioForPage(idx) {
            let pageData = storyConfig[idx];
            if (pageData && pageData.forceFullVideo) return;

            if (pageData && pageData.id) {
                audioEl.src = `sound/${pageData.id}.mp3`;
                audioEl.play().catch(e => console.log('Audio autoplay blocked'));
            } else {
                audioEl.pause();
            }
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            const btn = document.getElementById('playPauseBtn');
            btn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            updateBook(); 
        }

        function toggleMute() {
            const allMedia = [...document.querySelectorAll('video'), audioEl, document.getElementById('sfxWin'), document.getElementById('sfxWrong')];
            let isMuted = !audioEl.muted; 
            allMedia.forEach(m => m.muted = isMuted);
            
            const btn = document.getElementById('muteBtn');
            btn.innerHTML = audioEl.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        }

        initBook();

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') nextPage();
            if (e.key === 'ArrowLeft') prevPage();
        });

    </script>
</body>
</html>